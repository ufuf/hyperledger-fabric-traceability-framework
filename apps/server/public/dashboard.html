<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TURKCELL POC Dashboard</title>

  <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/dashboard/">



  <!-- Bootstrap core CSS -->
  <link href="/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>

  <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <img class="navbar-brand col-md-3 col-lg-2 me-0 px-3" src="/images/turkcell_yatay.png" alt="" width="%100"
      height="%100">
    <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse"
      data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <input id="searchInput" class="form-control form-control-dark w-100" type="text" placeholder="Search"
      aria-label="Search">
    <div class="navbar-nav">
      <div class="nav-item text-nowrap">
        <a class="nav-link px-3" href="#" onclick="logout();">Sign out</a>
      </div>
    </div>
  </header>

  <div class="container-fluid">
    <div class="row">
      <main class="col-md-12 ms-sm-auto col-lg-12 px-md-4">
        <div
          class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Battery Tracker <span data-feather="battery"></span></h1>
        </div>

        <h2>Bilgiler</h2>
        <div class="justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          id="infoBox">
        </div>

        <h2>İşlemler</h2>
        <div class="row">
          <div class="row">
            <div class="col">
              <ol class="list-group list-group-numbered border-bottom pt-3 pb-2 mb-3 " id="olPanel">

              </ol>

              <div id="maps">

              </div>

            </div>
            <div class="col">
              <h4>İşlem Detayı</h4>
              <div id="transactionDetail">

              </div>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>


  <script src="/js/bootstrap.bundle.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"
    integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE"
    crossorigin="anonymous"></script>
  <script src="/js/dashboard.js"></script>
  <script>
    let data;

    const parseCookie = str =>
      str
        .split(';')
        .map(v => v.split('='))
        .reduce((acc, v) => {
          acc[decodeURIComponent(v[0].trim())] = decodeURIComponent(v[1].trim());
          return acc;
        }, {});

    let isAuth = false;
    let cookie = parseCookie(document.cookie);
    if (!cookie.auth)
      window.location.href = '/login.html';
    else
      isAuth = true;


    function logout() {
      document.cookie = "auth=";
      window.location.href = '/login.html';
    }

    // Get the input field
    var input = document.getElementById("searchInput");

    // Execute a function when the user releases a key on the keyboard
    input.addEventListener("keyup", function (event) {
      // Number 13 is the "Enter" key on the keyboard
      if (event.keyCode === 13) {
        // Cancel the default action, if needed
        event.preventDefault();
        // Trigger the button element with a click
        var settings = {
          "url": "http://3.121.42.41:5000/api/v1/asset/history/" + $('#searchInput').val(),
          "method": "GET",
          "timeout": 0,
          "headers": {
            "Authorization": "Bearer " + cookie.auth,
            "Content-Type": "application/json"
          },
        };

        $.ajax(settings).done(function (response) {
          $('#olPanel').html("");
          $('#infoBox').html("");


          data = response.data;

          response.data.forEach((element, index) => {
            if (index == 0) {
              let infoHtml = "<div class=\"fw-bold\">" + element.name + "</div>" +
                "Make: " + element.make + "</br>" +
                "Model: " + element.model + "</br>" +
                "Serial Number: " + element.serialNumber + "</br>" +
                "Production Date: " + element.productionDate + "</br>" +
                "</div>";

              $('#infoBox').append('' + infoHtml);
            }

            let date = new Date(element.updatedAt);
            let dateStr = date.toLocaleString();

            let innerHtml =
              "<li class=\"list-group-item  list-group-item-action d-flex justify-content-between align-items-start\" onclick=\"showDetail(" + index + ");\">";
            innerHtml += "<div class=\"fw-bold flex-fill\">" + dateStr + "</div>";
            innerHtml += element.currentState == "SOLD TO CUSTOMER" ?
              "<span class=\"badge bg-success rounded-pill me-auto\">" + element.currentState + "</span>&nbsp&nbsp" + " <span class=\"float-end me-auto\" " + "data-feather=\"dollar-sign\">" :
              element.currentState == "IN FULLFILLMENT CENTER" ?
                "<span class=\"badge bg-info text-dark rounded-pill me-auto\">" + element.currentState + "</span>&nbsp&nbsp" + " <span class=\"float-end me-auto\" " + "data-feather=\"package\">" :
                element.currentState == "IN SHOP" ?
                  "<span class=\"badge bg-warning text-dark rounded-pill me-auto\">" + element.currentState + "</span>&nbsp&nbsp" + " <span class=\"float-end me-auto\" " + "data-feather=\"shopping-bag\">" :
                  "<span class=\"badge bg-secondary rounded-pill me-auto\">" + element.currentState + "</span>&nbsp&nbsp" + " <span class=\"float-end me-auto\" " + "data-feather=\"truck\">";

            innerHtml += "</span></li>";

            $('#olPanel').append('' + innerHtml);
            feather.replace();
          });
        }).fail(function (response) {
          $('#olPanel').html("");
          $('#infoBox').html("");
          $('#maps').html("");
          alert(response.responseJSON.error);
        });
      }
    });

    function showDetail(index) {
      let element = data[index];

      $('#maps').html("");
      $('#transactionDetail').html("");

      let transactionDetail = "<pre>" + JSON.stringify(element, null, 2) + "</pre>";
      $('#transactionDetail').append('' + transactionDetail);

      if (element.extraData.Location) {
        let mapsHtml = "<div class=\"d-flex justify-content-center\" id=\"loading\"><div class=\"spinner-border\" role=\"status\"></div></div>";
        mapsHtml += "<iframe " +
          "src=\"https://maps.google.com/maps?width=100%25&amp;height=600&amp;hl=en&amp;q=" + element.extraData.Location + "&amp;t=&amp;z=14&amp;ie=UTF8&amp;iwloc=B&amp;output=embed\"" +
          "width=\"600\" height=\"450\" style=\"border:0; opacity: 0;\" allowfullscreen=\"\" loading=\"lazy\" id=\"iframe\"></iframe>";

        $('#maps').html('' + mapsHtml);

        const iframeEle = document.getElementById('iframe');
        const loadingEle = document.getElementById('loading');

        iframeEle.addEventListener('load', function () {
          // Hide the loading indicator
          loadingEle.style.opacity = 0;
          // Bring the iframe back
          iframeEle.style.opacity = 1;
        });
      }
    }

  </script>
</body>

</html>